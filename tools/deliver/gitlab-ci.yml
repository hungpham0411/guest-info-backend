deliver:
  image: node:18
  stage: deliver

  rules:
    # Only run when an MR is merged into main.
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push")

  before_script:
    # Install git and bash.
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates bash

    # Install semantic-release and its plugins.
    - npm install -g semantic-release @semantic-release/{git,gitlab,exec} conventional-changelog-conventionalcommits

    # semantic-release requires its configuration to be in the root.
    - ln -s tools/deliver/releaserc.yaml ./.releaserc.yaml

  script:
    - semantic-release

  dependencies:
    - build
